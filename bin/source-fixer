#! /usr/bin/env node

const { loadGraphFromLocalDatabase, printConsoleResult } = require('..');

const dir = '.'
// const dir = '../fs-refactor'
const replaceFrom = 'getTag'
const replaceTo = 'getTagAsString'

async function main() {

    const graph = loadGraphFromLocalDatabase();

    const compileErrs = (await graph.runAsync(`get tsc-compile dir(${dir}) filename message lineno colno`))
        .filter(tup => !tup.hasAttr('command-meta'));

    console.log('Ran TSC, compile error count = ' + compileErrs.length);
    printConsoleResult(compileErrs);

    for (const err of compileErrs) {
        console.log('looking at error: ', err.stringify());

        const filename = err.getValueForType('filename');
        const lineno = err.getValueForType('lineno');

        const workingFileId = (await graph.runAsync(`get working-file((new)) filename(${filename})`))
            .filter(tup => !tup.hasAttr('command-meta'))
            [0]
            .getValueForType('working-file');

        const existingLine = (await graph.runAsync(`get working-file(${workingFileId}) line(${lineno}) text`))
            .filter(tup => !tup.hasAttr('command-meta'))
            [0]
            .getValueForType('text');

        const newLine = existingLine.replace(replaceFrom, replaceTo);

        await graph.setAsync({ 'working-file': workingFileId, line: lineno, text: newLine });
        await graph.setAsync({ 'working-file': workingFileId, commit: true });
    }
}

main()
.catch(console.error);
